<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plate and Byte - Restaurant Management</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/waiter_index.css') }}">
</head>
<body>
    <div class="container">
        <nav>
            <a href="#" class="logo">Plate & Byte</a>
            <ul class="nav-links">
                <li><a href="#">Menu</a></li>
                <li><a href="#">Reports</a></li>
                <li><a href="#">Settings</a></li>
            </ul>
        </nav>
        
        <h1 class="page-title">Restaurant <span>Floor Plan</span></h1>
        
        <!-- Edit Mode Banner -->
        <div id="editModeBanner" class="edit-mode-banner">
            You are in layout edit mode. Click "Save Layout" when finished.
        </div>
        
        <div class="main-content">
            <div class="sidebar">
                <h3 style="margin-top: 25px;">Table Status</h3>
                <div style="display: flex; align-items: center; margin: 10px 0;">
                    <div style="width: 12px; height: 12px; border-radius: 50%; background-color: #4CAF50; margin-right: 10px;"></div>
                    <span>Available</span>
                </div>
                <div style="display: flex; align-items: center; margin: 10px 0;">
                    <div style="width: 12px; height: 12px; border-radius: 50%; background-color: #FFC107; margin-right: 10px;"></div>
                    <span>Occupied</span>
                </div>
                <div style="display: flex; align-items: center; margin: 10px 0;">
                    <div style="width: 12px; height: 12px; border-radius: 50%; background-color: #F44336; margin-right: 10px;"></div>
                    <span>Dirty</span>
                </div>
                <p style="margin-top: 20px; font-size: 0.9rem;">Double-click on a table to assign a waiter and change status</p>
                
                <div id="layoutEditHelp" style="margin-top: 20px; display: none;">
                    <h4>Layout Edit Mode:</h4>
                    <ul style="padding-left: 20px; font-size: 0.9rem; margin-top: 10px;">
                        <li>Click on tables to select them</li>
                        <li>Use "Join Tables" to combine selected tables</li>
                        <li>Double-click a table to configure seats</li>
                    </ul>
                </div>
            </div>

            <div class="seating-grid" id="seatingGrid">
                {% for i in range(5) %}
                    {% for j in range(5) %}
                        <div class="cell available small" id="table-{{ i*5 + j + 1 }}" data-table-id="{{ i*5 + j + 1 }}" 
                             data-seats="4" data-size="small" onclick="handleTableClick(this)" ondblclick="openTableModal(this)">
                            <div class="status-indicator"></div>
                            <div class="drag-handle" style="display: none;"></div>
                            <p>Table #{{ i*5 + j + 1 }}</p>
                            <div class="capacity">Seats: 4</div>
                            <div class="seats-indicator">
                                <div class="seat"></div>
                                <div class="seat"></div>
                                <div class="seat"></div>
                                <div class="seat"></div>
                            </div>
                            <div class="waiter-info" id="waiter-info-{{ i*5 + j + 1 }}"></div>
                        </div>
                    {% endfor %}
                {% endfor %}
            </div>
        </div>
    </div>
    
    <!-- Table Management Modal -->
    <div id="tableModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTableTitle">Table #1</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <!-- Table Configuration Section (shown in edit mode) -->
                <div id="tableConfigSection" style="display: none;">
                    <div class="table-config-section">
                        <h4>Table Size</h4>
                        <div class="table-size-options">
                            <label class="size-option">
                                <input type="radio" name="tableSize" value="small" checked>
                                <span>Small (2-4 seats)</span>
                            </label>
                            <label class="size-option">
                                <input type="radio" name="tableSize" value="medium">
                                <span>Medium (4-6 seats)</span>
                            </label>
                            <label class="size-option">
                                <input type="radio" name="tableSize" value="large">
                                <span>Large (8+ seats)</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="table-config-section">
                        <h4>Number of Seats</h4>
                        <div class="seat-counter">
                            <button type="button" id="decreaseSeats">-</button>
                            <span id="seatCount">4</span>
                            <button type="button" id="increaseSeats">+</button>
                        </div>
                    </div>
                    
                    <div id="joinTablesSection" class="join-tables-section" style="display: none;">
                        <h4>Joined Tables</h4>
                        <p>This table is joined with:</p>
                        <div id="joinedTablesList" class="joined-tables-list">
                            <!-- Joined tables will be listed here -->
                        </div>
                    </div>
                </div>
                
                <!-- Regular Table Status Section -->
                <div id="tableStatusSection">
                    <h4>Change Status</h4>
                    <div class="status-options">
                        <label class="status-option">
                            <input type="radio" name="tableStatus" value="available" checked>
                            <div class="status-circle available"></div>
                            <span>Available</span>
                        </label>
                        <label class="status-option">
                            <input type="radio" name="tableStatus" value="occupied">
                            <div class="status-circle occupied"></div>
                            <span>Occupied</span>
                        </label>
                        <label class="status-option">
                            <input type="radio" name="tableStatus" value="dirty">
                            <div class="status-circle dirty"></div>
                            <span>Dirty</span>
                        </label>
                    </div>
                    
                    <h4>Assign Waiter</h4>
                    <select id="waiterSelect" style="width: 100%; padding: 8px; margin-top: 5px; border-radius: 4px; border: 1px solid #ddd;">
                        <option value="">Select a waiter</option>
                        <!-- Waiters will be loaded here -->
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="secondary" onclick="closeModal()">Cancel</button>
                <button id="saveTableConfigBtn" class="primary" style="display: none;" onclick="saveTableConfig()">Save Configuration</button>
                <button id="saveTableStatusBtn" class="primary" onclick="saveTableChanges()">Save Changes</button>
            </div>
        </div>
    </div>
    
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-logo">Plate & Byte</div>
            </div>
            <div class="copyright">
                &copy; 2025 Plate & Byte. All rights reserved.
            </div>
        </div>
    </footer>
    
    <script>

    const tableData = {};
    let currentTableId = null;
    const modal = document.getElementById('tableModal');
    const modalTitle = document.getElementById('modalTableTitle');
    const waiterSelect = document.getElementById('waiterSelect');
    
    // Layout editing variables
    let isEditMode = false;
    let selectedTables = [];
    let joinedTables = {};
    let originalLayout = null;
    
    // DOM Elements
    const editLayoutBtn = document.getElementById('editLayoutBtn');
    const addTableBtn = document.getElementById('addTableBtn');
    const joinTablesBtn = document.getElementById('joinTablesBtn');
    const saveLayoutBtn = document.getElementById('saveLayoutBtn');
    const cancelEditBtn = document.getElementById('cancelEditBtn');
    const editModeBanner = document.getElementById('editModeBanner');
    const layoutEditHelp = document.getElementById('layoutEditHelp');
    const seatingGrid = document.getElementById('seatingGrid');
    
    // Table configuration elements
    const tableConfigSection = document.getElementById('tableConfigSection');
    const tableStatusSection = document.getElementById('tableStatusSection');
    const saveTableConfigBtn = document.getElementById('saveTableConfigBtn');
    const saveTableStatusBtn = document.getElementById('saveTableStatusBtn');
    const decreaseSeatsBtn = document.getElementById('decreaseSeats');
    const increaseSeatsBtn = document.getElementById('increaseSeats');
    const seatCountEl = document.getElementById('seatCount');
    const joinTablesSection = document.getElementById('joinTablesSection');
    const joinedTablesList = document.getElementById('joinedTablesList');
    
    // Close modal when clicking on X
    document.querySelector('.close').addEventListener('click', closeModal);
    
    // Close modal when clicking outside
    window.addEventListener('click', function(event) {
        if (event.target === modal) {
            closeModal();
        }
    });
    
    // Load waiters when the page loads
    document.addEventListener('DOMContentLoaded', function() {
        loadWaiters();
        loadTableData();
        setupEventListeners();
    });
    
    function setupEventListeners() {
        // Layout control buttons
        editLayoutBtn.addEventListener('click', toggleEditMode);
        addTableBtn.addEventListener('click', addNewTable);
        joinTablesBtn.addEventListener('click', joinSelectedTables);
        saveLayoutBtn.addEventListener('click', saveLayout);
        cancelEditBtn.addEventListener('click', cancelEdit);
        
        // Seat counter buttons
        decreaseSeatsBtn.addEventListener('click', function() {
            let count = parseInt(seatCountEl.textContent);
            if (count > 2) {
                seatCountEl.textContent = count - 1;
                updateSeatsIndicator(count - 1);
            }
        });
        
        increaseSeatsBtn.addEventListener('click', function() {
            let count = parseInt(seatCountEl.textContent);
            if (count < 12) {
                seatCountEl.textContent = count + 1;
                updateSeatsIndicator(count + 1);
            }
        });
        
        // Table size radio buttons
        document.querySelectorAll('input[name="tableSize"]').forEach(radio => {
            radio.addEventListener('change', function() {
                updateTableSizePreview(this.value);
            });
        });
    }
    
    function loadWaiters() {
        fetch('/api/waiters')
            .then(response => response.json())
            .then(data => {
                waiterSelect.innerHTML = '<option value="">Select a waiter</option>';
                data.forEach(waiter => {
                    const option = document.createElement('option');
                    option.value = waiter.username;
                    option.textContent = waiter.name;
                    option.dataset.waiterId = waiter.id;
                    waiterSelect.appendChild(option);
                });
            })
            .catch(error => console.error('Error loading waiters:', error));
    }
    
    function loadTableData() {
        fetch('/api/tables')
            .then(response => response.json())
            .then(data => {
                data.forEach(table => {
                    const tableId = table.table_id;
                    const tableElement = document.getElementById(`table-${tableId}`);
                    
                    if (tableElement) {
                        // Convert status from backend format to frontend format
                        let status = 'available';
                        if (table.status === 'Occupied') status = 'occupied';
                        else if (table.status === 'Dirty') status = 'dirty';
                        
                        // Update table class and status indicator
                        tableElement.className = `cell ${status} ${tableElement.dataset.size || 'small'}`;
                        const statusIndicator = tableElement.querySelector('.status-indicator');
                        statusIndicator.className = `status-indicator ${status}`;
                        
                        // Update waiter info if assigned
                        if (table.waiter_id) {
                            const waiterInfoElement = document.getElementById(`waiter-info-${tableId}`);
                            // You would need to fetch waiter name based on ID
                            // For now, just show the ID
                            waiterInfoElement.textContent = `Waiter ID: ${table.waiter_id}`;
                        }
                        
                        // Store table data
                        tableData[tableId] = {
                            status: status,
                            waiter_id: table.waiter_id || '',
                            seats: parseInt(tableElement.dataset.seats) || 4,
                            size: tableElement.dataset.size || 'small',
                            joined: tableElement.classList.contains('joined')
                        };
                    }
                });
            })
            .catch(error => console.error('Error loading tables:', error));
    }
    
    function handleTableClick(element) {
        if (isEditMode) {
            // In edit mode, clicking selects/deselects tables
            toggleTableSelection(element);
        } else {
            // Regular mode functionality if needed
        }
    }
    
    function toggleTableSelection(element) {
        const tableId = element.dataset.tableId;
        
        if (element.classList.contains('selected')) {
            // Deselect table
            element.classList.remove('selected');
            selectedTables = selectedTables.filter(id => id !== tableId);
        } else {
            // Select table
            element.classList.add('selected');
            selectedTables.push(tableId);
        }
        
        // Enable/disable join button based on selection
        joinTablesBtn.disabled = selectedTables.length < 2;
    }
    
    function openTableModal(element) {
        const tableId = element.dataset.tableId;
        currentTableId = tableId;
        modalTitle.textContent = `Table #${tableId}`;
        
        if (isEditMode) {
            // In edit mode, show table configuration options
            tableConfigSection.style.display = 'block';
            tableStatusSection.style.display = 'none';
            saveTableConfigBtn.style.display = 'block';
            saveTableStatusBtn.style.display = 'none';
            
            // Set current table size
            const currentSize = element.dataset.size || 'small';
            document.querySelector(`input[name="tableSize"][value="${currentSize}"]`).checked = true;
            
            // Set current seat count
            const seatCount = parseInt(element.dataset.seats) || 4;
            seatCountEl.textContent = seatCount;
            
            // Check if this is a joined table
            if (element.classList.contains('joined')) {
                joinTablesSection.style.display = 'block';
                updateJoinedTablesList(tableId);
            } else {
                joinTablesSection.style.display = 'none';
            }
        } else {
            // Regular mode - show status options
            tableConfigSection.style.display = 'none';
            tableStatusSection.style.display = 'block';
            saveTableConfigBtn.style.display = 'none';
            saveTableStatusBtn.style.display = 'block';
            
            // Set current status in modal
            const currentStatus = element.classList.contains('occupied') ? 'occupied' : 
                                element.classList.contains('dirty') ? 'dirty' : 'available';
            
            document.querySelector(`input[name="tableStatus"][value="${currentStatus}"]`).checked = true;
            
            // Set current waiter in modal if assigned
            if (tableData[tableId] && tableData[tableId].waiter) {
                waiterSelect.value = tableData[tableId].waiter;
            } else {
                waiterSelect.value = "";
            }
        }
        
        modal.style.display = 'block';
    }
    
    function closeModal() {
        modal.style.display = 'none';
        currentTableId = null;
    }
    
    function saveTableChanges() {
        if (!currentTableId) return;
        
        const tableElement = document.getElementById(`table-${currentTableId}`);
        const statusIndicator = tableElement.querySelector('.status-indicator');
        const waiterInfoElement = document.getElementById(`waiter-info-${currentTableId}`);
        
        // Get selected status
        const selectedStatus = document.querySelector('input[name="tableStatus"]:checked').value;
        
        // Get selected waiter
        const selectedWaiter = waiterSelect.value;
        const selectedWaiterName = selectedWaiter ? waiterSelect.options[waiterSelect.selectedIndex].text : '';
        
        // Get the waiter ID from the data attribute
        const selectedWaiterId = selectedWaiter ? 
            waiterSelect.options[waiterSelect.selectedIndex].dataset.waiterId : '';
        
        // Update table data
        tableData[currentTableId] = {
            ...tableData[currentTableId],
            status: selectedStatus,
            waiter: selectedWaiter,
            waiterName: selectedWaiterName,
            waiterId: selectedWaiterId
        };
        
        // Update visual status
        tableElement.classList.remove('available', 'occupied', 'dirty');
        tableElement.classList.add(selectedStatus);
        statusIndicator.className = 'status-indicator ' + selectedStatus;
        
        // Update waiter info
        if (selectedWaiter) {
            waiterInfoElement.textContent = `Waiter: ${selectedWaiterName}`;
        } else {
            waiterInfoElement.textContent = '';
        }
        
        // Send update to server
        fetch('/api/update_table', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                table_id: currentTableId,
                status: selectedStatus,
                waiter_id: selectedWaiterId
            }),
        })
        .then(response => response.json())
        .then(data => {
            console.log('Success:', data);
        })
        .catch((error) => {
            console.error('Error:', error);
        });
        
        closeModal();
    }
    
    function saveTableConfig() {
        if (!currentTableId) return;
        
        const tableElement = document.getElementById(`table-${currentTableId}`);
        
        // Get selected size
        const selectedSize = document.querySelector('input[name="tableSize"]:checked').value;
        
        // Get seat count
        const seatCount = parseInt(seatCountEl.textContent);
        
        // Update table element
        tableElement.classList.remove('small', 'medium', 'large');
        tableElement.classList.add(selectedSize);
        tableElement.dataset.size = selectedSize;
        tableElement.dataset.seats = seatCount;
        
        // Update capacity display
        const capacityEl = tableElement.querySelector('.capacity');
        capacityEl.textContent = `Seats: ${seatCount}`;
        
        // Update seats indicator
        updateTableSeatsIndicator(tableElement, seatCount);
        
        // Update table data
        tableData[currentTableId] = {
            ...tableData[currentTableId],
            size: selectedSize,
            seats: seatCount
        };
        
        // Send update to server
        fetch('/api/update_table_config', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                table_id: currentTableId,
                size: selectedSize,
                seats: seatCount,
                joined_with: joinedTables[currentTableId] || []
            }),
        })
        .then(response => response.json())
        .then(data => {
            console.log('Configuration saved:', data);
        })
        .catch((error) => {
            console.error('Error saving configuration:', error);
        });
        
        closeModal();
    }
    
    function toggleEditMode() {
        isEditMode = !isEditMode;
        
        if (isEditMode) {
            // Enter edit mode
            editModeBanner.classList.add('active');
            layoutEditHelp.style.display = 'block';
            editLayoutBtn.classList.add('active');
            addTableBtn.disabled = false;
            saveLayoutBtn.disabled = false;
            cancelEditBtn.disabled = false;
            
            // Save original layout for cancel operation
            originalLayout = seatingGrid.innerHTML;
            
            // Show drag handles
            document.querySelectorAll('.drag-handle').forEach(handle => {
                handle.style.display = 'block';
            });
            
            // Make tables draggable
            enableDraggableTables();
        } else {
            // Exit edit mode
            exitEditMode();
        }
    }
    
    function exitEditMode() {
        isEditMode = false;
        editModeBanner.classList.remove('active');
        layoutEditHelp.style.display = 'none';
        editLayoutBtn.classList.remove('active');
        addTableBtn.disabled = true;
        joinTablesBtn.disabled = true;
        saveLayoutBtn.disabled = true;
        cancelEditBtn.disabled = true;
        
        // Clear selected tables
        selectedTables = [];
        document.querySelectorAll('.cell.selected').forEach(table => {
            table.classList.remove('selected');
        });
        
        // Hide drag handles
        document.querySelectorAll('.drag-handle').forEach(handle => {
            handle.style.display = 'none';
        });
        
        // Disable draggable tables
        disableDraggableTables();
    }
    
    function addNewTable() {
        // Get the next table ID
        const tables = document.querySelectorAll('.cell');
        const nextId = tables.length + 1;
        
        // Create new table element
        const newTable = document.createElement('div');
        newTable.className = 'cell available small';
        newTable.id = `table-${nextId}`;
        newTable.dataset.tableId = nextId;
        newTable.dataset.seats = 4;
        newTable.dataset.size = 'small';
        newTable.onclick = function() { handleTableClick(this); };
        newTable.ondblclick = function() { openTableModal(this); };
        
        // Add table content
        newTable.innerHTML = `
            <div class="status-indicator"></div>
            <div class="drag-handle"></div>
            <p>Table #${nextId}</p>
            <div class="capacity">Seats: 4</div>
            <div class="seats-indicator">
                <div class="seat"></div>
                <div class="seat"></div>
                <div class="seat"></div>
                <div class="seat"></div>
            </div>
            <div class="waiter-info" id="waiter-info-${nextId}"></div>
        `;
        
        // Add to grid
                // Add to grid
                seatingGrid.appendChild(newTable);
        
                // Make the new table draggable
                makeDraggable(newTable);
                
                // Store table data
                tableData[nextId] = {
                    status: 'available',
                    waiter: '',
                    waiterName: '',
                    waiterId: '',
                    seats: 4,
                    size: 'small',
                    joined: false
                };
            }
            
            function joinSelectedTables() {
                if (selectedTables.length < 2) return;
                
                // Sort selected tables by ID for consistency
                selectedTables.sort((a, b) => parseInt(a) - parseInt(b));
                
                // The first table becomes the primary table
                const primaryTableId = selectedTables[0];
                const primaryTable = document.getElementById(`table-${primaryTableId}`);
                
                // Mark the primary table as joined
                primaryTable.classList.add('joined');
                
                // Add join indicator to primary table
                let joinIndicator = primaryTable.querySelector('.join-indicator');
                if (!joinIndicator) {
                    joinIndicator = document.createElement('div');
                    joinIndicator.className = 'join-indicator';
                    primaryTable.appendChild(joinIndicator);
                }
                joinIndicator.textContent = selectedTables.length;
                
                // Store joined tables information
                joinedTables[primaryTableId] = selectedTables.slice(1);
                
                // Update the primary table's seat count
                let totalSeats = 0;
                selectedTables.forEach(tableId => {
                    const table = document.getElementById(`table-${tableId}`);
                    totalSeats += parseInt(table.dataset.seats) || 4;
                    
                    // If not the primary table, hide it
                    if (tableId !== primaryTableId) {
                        table.style.visibility = 'hidden';
                        table.classList.add('part-of-joined');
                        table.dataset.joinedWith = primaryTableId;
                    }
                });
                
                // Update primary table capacity
                primaryTable.dataset.seats = totalSeats;
                const capacityEl = primaryTable.querySelector('.capacity');
                capacityEl.textContent = `Seats: ${totalSeats}`;
                
                // Update seats indicator
                updateTableSeatsIndicator(primaryTable, totalSeats);
                
                // Update table data
                tableData[primaryTableId] = {
                    ...tableData[primaryTableId],
                    seats: totalSeats,
                    joined: true,
                    joinedWith: joinedTables[primaryTableId]
                };
                
                // Clear selection
                selectedTables.forEach(tableId => {
                    const table = document.getElementById(`table-${tableId}`);
                    table.classList.remove('selected');
                });
                selectedTables = [];
                joinTablesBtn.disabled = true;
            }
            
            function updateJoinedTablesList(tableId) {
                joinedTablesList.innerHTML = '';
                
                if (joinedTables[tableId] && joinedTables[tableId].length > 0) {
                    joinedTables[tableId].forEach(joinedId => {
                        const listItem = document.createElement('div');
                        listItem.className = 'joined-table-item';
                        listItem.innerHTML = `
                            <span>Table #${joinedId}</span>
                            <span class="remove-joined" data-table-id="${joinedId}">×</span>
                        `;
                        joinedTablesList.appendChild(listItem);
                    });
                    
                    // Add event listeners to remove buttons
                    joinedTablesList.querySelectorAll('.remove-joined').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const tableToRemove = this.dataset.tableId;
                            unjoinTable(tableId, tableToRemove);
                        });
                    });
                } else {
                    joinedTablesList.innerHTML = '<p>No tables joined</p>';
                }
            }
            
            function unjoinTable(primaryTableId, tableToRemoveId) {
                // Remove table from joined list
                joinedTables[primaryTableId] = joinedTables[primaryTableId].filter(id => id !== tableToRemoveId);
                
                // Update join indicator
                const primaryTable = document.getElementById(`table-${primaryTableId}`);
                const joinIndicator = primaryTable.querySelector('.join-indicator');
                
                if (joinedTables[primaryTableId].length === 0) {
                    // No more joined tables, remove joined status
                    primaryTable.classList.remove('joined');
                    if (joinIndicator) primaryTable.removeChild(joinIndicator);
                    delete joinedTables[primaryTableId];
                } else {
                    // Update join indicator count
                    joinIndicator.textContent = joinedTables[primaryTableId].length + 1;
                }
                
                // Make the removed table visible again
                const tableToRemove = document.getElementById(`table-${tableToRemoveId}`);
                tableToRemove.style.visibility = 'visible';
                tableToRemove.classList.remove('part-of-joined');
                delete tableToRemove.dataset.joinedWith;
                
                // Recalculate seats for primary table
                let remainingSeats = parseInt(primaryTable.dataset.originalSeats || 4);
                if (joinedTables[primaryTableId]) {
                    joinedTables[primaryTableId].forEach(id => {
                        const table = document.getElementById(`table-${id}`);
                        remainingSeats += parseInt(table.dataset.seats || 4);
                    });
                }
                
                // Update primary table capacity
                primaryTable.dataset.seats = remainingSeats;
                const capacityEl = primaryTable.querySelector('.capacity');
                capacityEl.textContent = `Seats: ${remainingSeats}`;
                
                // Update seats indicator
                updateTableSeatsIndicator(primaryTable, remainingSeats);
                
                // Update table data
                tableData[primaryTableId] = {
                    ...tableData[primaryTableId],
                    seats: remainingSeats,
                    joined: joinedTables[primaryTableId] ? true : false,
                    joinedWith: joinedTables[primaryTableId] || []
                };
                
                // Update the joined tables list in the modal
                updateJoinedTablesList(primaryTableId);
            }
            
            function saveLayout() {
                // Prepare layout data
                const layoutData = {
                    tables: Object.keys(tableData).map(tableId => ({
                        id: tableId,
                        ...tableData[tableId],
                        position: getTablePosition(tableId)
                    })),
                    joinedTables: joinedTables
                };
                
                // Send to server
                fetch('/api/save_layout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(layoutData),
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Layout saved:', data);
                    // Exit edit mode
                    exitEditMode();
                })
                .catch((error) => {
                    console.error('Error saving layout:', error);
                    alert('Error saving layout. Please try again.');
                });
            }
            
            function getTablePosition(tableId) {
                const table = document.getElementById(`table-${tableId}`);
                const rect = table.getBoundingClientRect();
                const gridRect = seatingGrid.getBoundingClientRect();
                
                return {
                    left: rect.left - gridRect.left,
                    top: rect.top - gridRect.top,
                    width: rect.width,
                    height: rect.height
                };
            }
            
            function cancelEdit() {
                // Restore original layout
                if (originalLayout) {
                    seatingGrid.innerHTML = originalLayout;
                    
                    // Reattach event handlers
                    document.querySelectorAll('.cell').forEach(cell => {
                        cell.onclick = function() { handleTableClick(this); };
                        cell.ondblclick = function() { openTableModal(this); };
                    });
                }
                
                // Reset joined tables
                joinedTables = {};
                
                // Exit edit mode
                exitEditMode();
            }
            
            function updateTableSizePreview(size) {
                // This function would update a preview of the table size
                // For simplicity, we're just logging it
                console.log(`Table size changed to: ${size}`);
            }
            
            function updateSeatsIndicator(count) {
                // This function would update a preview of the seats
                // For simplicity, we're just logging it
                console.log(`Seat count changed to: ${count}`);
            }
            
            function updateTableSeatsIndicator(tableElement, seatCount) {
                const seatsIndicator = tableElement.querySelector('.seats-indicator');
                seatsIndicator.innerHTML = '';
                
                // Create seat indicators (max visual representation is 8)
                const visualSeats = Math.min(seatCount, 8);
                for (let i = 0; i < visualSeats; i++) {
                    const seat = document.createElement('div');
                    seat.className = 'seat';
                    seatsIndicator.appendChild(seat);
                }
                
                // If more than 8 seats, add a +X indicator
                if (seatCount > 8) {
                    const extraSeats = document.createElement('span');
                    extraSeats.textContent = `+${seatCount - 8}`;
                    extraSeats.style.fontSize = '0.7rem';
                    extraSeats.style.marginLeft = '3px';
                    seatsIndicator.appendChild(extraSeats);
                }
            }
            
            function enableDraggableTables() {
                document.querySelectorAll('.cell').forEach(table => {
                    makeDraggable(table);
                });
            }
            
            function disableDraggableTables() {
                document.querySelectorAll('.cell').forEach(table => {
                    table.onmousedown = null;
                });
            }
            
            function makeDraggable(element) {
                let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
                const handle = element.querySelector('.drag-handle');
                
                if (handle) {
                    // If there's a handle, make only the handle trigger dragging
                    handle.onmousedown = dragMouseDown;
                } else {
                    // Otherwise, make the whole element draggable
                    element.onmousedown = dragMouseDown;
                }
                
                function dragMouseDown(e) {
                    e = e || window.event;
                    e.preventDefault();
                    // Get the mouse cursor position at startup
                    pos3 = e.clientX;
                    pos4 = e.clientY;
                    document.onmouseup = closeDragElement;
                    // Call a function whenever the cursor moves
                    document.onmousemove = elementDrag;
                    
                    // Add a class to indicate dragging
                    element.classList.add('dragging');
                }
                
                function elementDrag(e) {
                    e = e || window.event;
                    e.preventDefault();
                    // Calculate the new cursor position
                    pos1 = pos3 - e.clientX;
                    pos2 = pos4 - e.clientY;
                    pos3 = e.clientX;
                    pos4 = e.clientY;
                    
                    // Check if the new position is within the grid boundaries
                    const grid = seatingGrid.getBoundingClientRect();
                    const elem = element.getBoundingClientRect();
                    
                    let newTop = element.offsetTop - pos2;
                    let newLeft = element.offsetLeft - pos1;
                    
                    // Ensure the element stays within the grid
                    if (newTop < 0) newTop = 0;
                    if (newLeft < 0) newLeft = 0;
                    if (newTop + elem.height > grid.height) newTop = grid.height - elem.height;
                    if (newLeft + elem.width > grid.width) newLeft = grid.width - elem.width;
                    
                    // Set the element's new position
                    element.style.top = newTop + "px";
                    element.style.left = newLeft + "px";
                    element.style.position = "absolute";
                }
                
                function closeDragElement() {
                    // Stop moving when mouse button is released
                    document.onmouseup = null;
                    document.onmousemove = null;
                    element.classList.remove('dragging');
                }
            }
            
            // Initialize all tables
            document.addEventListener('DOMContentLoaded', function() {
                const tables = document.querySelectorAll('.cell');
                tables.forEach(table => {
                    const tableId = table.dataset.tableId;
                    tableData[tableId] = {
                        status: 'available',
                        waiter: '',
                        waiterName: '',
                        waiterId: '',
                        seats: parseInt(table.dataset.seats) || 4,
                        size: table.dataset.size || 'small',
                        joined: false
                    };
                    
                    // Store original seat count for unjoin operations
                    table.dataset.originalSeats = table.dataset.seats || 4;
                });
            });
        </script>
    </body>
</html>
